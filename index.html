<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Memorice Matemático - 1° a 4° Medio</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 1em;
    background: #f5f5f5;
  }
  h1 {
    text-align: center;
    margin-bottom: 0.5em;
  }
  #controls {
    text-align: center;
    margin-bottom: 1em;
  }
  select, button {
    font-size: 1rem;
    padding: 0.4em 0.8em;
    margin: 0 0.5em;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(4, 140px);
    grid-gap: 15px;
    justify-content: center;
    margin-bottom: 1em;
  }
  .card {
    background: #e0e0e0;
    border: 2px solid #ccc;
    height: 110px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    user-select: none;
    color: transparent;
    transition: background-color 0.3s, color 0.3s;
    padding: 0.5em;
    text-align: center;
    border-radius: 8px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }
  .card.flipped {
    background: #ffeb3b;
    color: black;
    cursor: default;
  }
  .card.matched {
    background: #4caf50;
    color: white;
    cursor: default;
  }
  .card.wrong {
    background: #f44336;
    color: white;
    cursor: default;
  }
  #explanation {
    min-height: 3em;
    margin-bottom: 1em;
    font-style: italic;
    text-align: center;
    color: #333;
  }
  #scoreboard, #timer {
    font-weight: bold;
    font-size: 1.1rem;
    margin: 0.3em 1em;
  }
  #info-bar {
    text-align: center;
    margin-bottom: 1em;
  }
  /* Colores para dificultad */
  .board-facil .card { border-color: #81c784; }
  .board-medio .card { border-color: #4caf50; }
  .board-dificil .card { border-color: #388e3c; }
  .board-extremo .card { border-color: #1b5e20; }
</style>
</head>
<body>

<h1>Memorice Matemático - 1° a 4° Medio</h1>

<div id="controls">
  Curso: 
  <select id="curso-select">
    <option value="1medio">1° Medio</option>
    <option value="2medio">2° Medio</option>
    <option value="3medio">3° Medio</option>
    <option value="4medio">4° Medio</option>
  </select>
  Dificultad: 
  <select id="dificultad-select">
    <option value="facil">Fácil</option>
    <option value="medio">Medio</option>
    <option value="dificil">Difícil</option>
    <option value="extremo">Extremo</option>
  </select>
  <button id="start-btn">Iniciar Juego</button>
</div>

<div id="info-bar">
  <span id="scoreboard">Puntaje: 0</span>
  <span id="timer">Tiempo: 00:00</span>
</div>

<div id="board" class="board-facil"></div>

<div id="explanation"></div>

<script>
  const bancoOperaciones = { /* Aquí va todo el banco de ejercicios tal como en tu versión anterior */ };
  const tiemposDificultad = { facil: 8*60, medio: 6*60, dificil: 4*60, extremo: 3*60 };

  const board = document.getElementById("board");
  const cursoSelect = document.getElementById("curso-select");
  const dificultadSelect = document.getElementById("dificultad-select");
  const startBtn = document.getElementById("start-btn");
  const explanationDiv = document.getElementById("explanation");
  const scoreboard = document.getElementById("scoreboard");
  const timerDisplay = document.getElementById("timer");

  let cursoActual = cursoSelect.value;
  let dificultadActual = dificultadSelect.value;
  let puntaje = 0;
  let cartasSeleccionadas = [];
  let temporizador = null;
  let tiempoRestante = 0;
  let bloqueoClick = false;

  function mezclarArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function crearCartas() {
    puntaje = 0;
    actualizarPuntaje();
    cartasSeleccionadas = [];
    explanationDiv.textContent = "";
    clearInterval(temporizador);

    cursoActual = cursoSelect.value;
    dificultadActual = dificultadSelect.value;

    const ejercicios = bancoOperaciones[cursoActual][dificultadActual];
    if (!ejercicios) { alert("No hay ejercicios para esta combinación."); return; }

    board.innerHTML = "";
    board.className = "board-" + dificultadActual;

    const seleccion = mezclarArray(ejercicios).slice(0, 8);
    const cartas = [];
    seleccion.forEach((item, index) => {
      cartas.push({id:index, tipo:"pregunta", text:item.pregunta, explicacion:item.explicacion});
      cartas.push({id:index, tipo:"respuesta", text:item.respuesta, explicacion:item.explicacion});
    });
    mezclarArray(cartas);

    cartas.forEach(c => {
      const cardDiv = document.createElement("div");
      cardDiv.classList.add("card");
      cardDiv.dataset.id = c.id;
      cardDiv.dataset.tipo = c.tipo;
      cardDiv.dataset.text = c.text;
      cardDiv.dataset.explicacion = c.explicacion;
      cardDiv.textContent = ""; // siempre dada vuelta al inicio
      cardDiv.addEventListener("click", manejarClickCarta);
      board.appendChild(cardDiv);
    });

    iniciarTemporizador();
  }

  function manejarClickCarta(e) {
    if (bloqueoClick) return;
    const carta = e.currentTarget;
    if (carta.classList.contains("flipped") || carta.classList.contains("matched")) return;

    carta.classList.add("flipped");
    carta.textContent = carta.dataset.text;

    cartasSeleccionadas.push(carta);

    if (cartasSeleccionadas.length === 2) {
      bloqueoClick = true;
      const [primera, segunda] = cartasSeleccionadas;

      if (primera.dataset.id === segunda.dataset.id && primera.dataset.tipo !== segunda.dataset.tipo) {
        primera.classList.add("matched");
        segunda.classList.add("matched");
        puntaje += 10;
        explanationDiv.textContent = "¡Correcto! " + primera.dataset.explicacion;
        setTimeout(() => {
          bloqueoClick = false;
          explanationDiv.textContent = "";
          revisarFinJuego();
        }, 1500);
      } else {
        puntaje = Math.max(0, puntaje - 5);
        explanationDiv.textContent = "Incorrecto. " + (segunda.dataset.explicacion || "Revisa bien el ejercicio.");
        primera.classList.add("wrong");
        segunda.classList.add("wrong");
        setTimeout(() => {
          primera.classList.remove("flipped", "wrong");
          segunda.classList.remove("flipped", "wrong");
          primera.textContent = "";
          segunda.textContent = "";
          explanationDiv.textContent = "";
          bloqueoClick = false;
        }, 1500);
      }
      actualizarPuntaje();
      cartasSeleccionadas = [];
    }
  }

  function actualizarPuntaje() { scoreboard.textContent = `Puntaje: ${puntaje}`; }

  function revisarFinJuego() {
    const todasCartas = Array.from(board.querySelectorAll(".card"));
    if (todasCartas.every(c => c.classList.contains("matched"))) {
      clearInterval(temporizador);
      explanationDiv.textContent = "¡Felicidades! Terminaste el juego.";
      bloquearCartas();
    }
  }

  function iniciarTemporizador() {
    clearInterval(temporizador);
    tiempoRestante = tiemposDificultad[dificultadActual];
    actualizarTiempo();
    temporizador = setInterval(() => {
      tiempoRestante--;
      actualizarTiempo();
      if (tiempoRestante <= 0) {
        clearInterval(temporizador);
        explanationDiv.textContent = "¡Se acabó el tiempo!";
        bloquearCartas();
        bloqueoClick = true;
      }
    }, 1000);
  }

  function actualizarTiempo() {
    const minutos = Math.floor(tiempoRestante / 60).toString().padStart(2, "0");
    const segundos = (tiempoRestante % 60).toString().padStart(2, "0");
    timerDisplay.textContent = `Tiempo: ${minutos}:${segundos}`;
  }

  function bloquearCartas() {
    const todasCartas = Array.from(board.querySelectorAll(".card"));
    todasCartas.forEach(c => {
      c.removeEventListener("click", manejarClickCarta);
      c.classList.add("flipped");
      c.textContent = c.dataset.text;
    });
  }

  startBtn.addEventListener("click", crearCartas);
  cursoSelect.addEventListener("change", () => { cursoActual = cursoSelect.value; });
  dificultadSelect.addEventListener("change", () => { 
    dificultadActual = dificultadSelect.value;
    board.className = "board-" + dificultadActual;
  });

  board.className = "board-" + dificultadActual;
  timerDisplay.textContent = "Tiempo: 00:00";
</script>

</body>
</html>
